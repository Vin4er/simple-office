<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
     <!--Задаем кодировку страницы-->
  <title>The Simple Editor v1.0</title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
</head>
<body>
 <!--
#####################################################################
##Name: The KIX KIX KIX Simple Editor;
##Version:  v1.0;
##Date:December 2011;
##Developer: Lubinskiy Sergey;
##Contacts: Vin4er1@yandex.ru; http://vkontakte.ru/fucked_brain_php;
#####################################################################
 -->
<div  class='edit' style='margin: 0px auto; width: 400px; min-height:100%; border:1px solid black'>

</div>


  <script>
    
    var newLine = $("<div class='kix-line' />")
    var cursor = $("<div class='kix-cursor'  style='border-right:2px solid blue; margin-left: -2px; display: inline;'></div>");
        
        $(".edit").append(newLine.clone());
        $(".edit .kix-line:first").append(cursor);
    
    var removeCursor = function(){
        $(".edit .kix-line .kix-cursor").remove()
    }

    $(function(){

        //Миигание курсора
        // var interval = setInterval(function(){
        //     cursor.animate({"opacity": "0"}, 600, function(){
        //         cursor.css("opacity", "1");
        //     });
        // }, 100)

//события
        $(document).live('keydown', function(eventObject){
            switch(eventObject.which){
                case 8: //backspace
                    cursor.prev(".kix-char").remove()
                break; 
                case 46: //del
                    cursor.next(".kix-char").remove()
                break;   

                case 38: //top
                    currIndexChar = $(".edit .kix-line .kix-cursor").prev().index() 
                    topLine =  $(".edit .kix-line .kix-cursor").parents(".kix-line").prev();
                    topCharSize = topLine.find(".kix-char").size();

                    if(topLine.size() > 0){  // если предыдущяя строка есть 
                        if( currIndexChar < topCharSize){
                            var afTerCursor  = topLine.find(".kix-char").eq(currIndexChar)
                            removeCursor();
                            afTerCursor.after(cursor)

                        }else{ // если первая строка
                            removeCursor()
                            topLine.find(".kix-char:last").after(cursor)
                        }
                    }
                break;  

                case 40: //bottom
                    currIndexChar = $(".edit .kix-line .kix-cursor").prev().index() 
                    topLine =  $(".edit .kix-line .kix-cursor").parents(".kix-line").next();
                    topCharSize = topLine.find(".kix-char").size()
                        
                    if(topLine.size()>0){     // если следующаяя строка есть 

                        if( currIndexChar < topCharSize){
                            var afTerCursor  = topLine.find(".kix-char").eq(currIndexChar)
                            removeCursor()
                            afTerCursor.after(cursor)

                        }else{ // если последняяя строчка
                            removeCursor()
                            topLine.find(".kix-char:last").after(cursor)
                        }
                    }
                break; 

                case 39: //right
                    obj = $(".edit .kix-line .kix-cursor").next()
                    if(obj.size() > 0){ // если следующий символ есть
                        removeCursor()   
                        obj.after(cursor)  
                    }else{ // если последний сивол
                        
                        var rigntNextBottom  = cursor.parents(".kix-line").next();
                        if(rigntNextBottom.size() > 0 ){ // если если есть внижу строчка
                            removeCursor() 
                            rigntNextBottom.prepend(cursor)
                        }
                    }
                break;  

                case 37: //left
                    obj = $(".edit .kix-line .kix-cursor").prev()
                    if(obj.size() > 0){ // если следующий символ есть                   
                        removeCursor()  
                        obj.before(cursor)
                    }else{// если первый сивол

                        var rigntNextBottom  = cursor.parents(".kix-line").prev();
                        if(rigntNextBottom.size() > 0 ){// если если есть внижу строчка
                            removeCursor() 
                            rigntNextBottom.append(cursor)
                        }
                    }
                break; 

                case 13: //enter
                //обработать перенос строки
                 eventObject.preventDefault()
                    cursor.parent(".kix-line").after(newLine.clone())
                    removeCursor()
                    $(".edit .kix-line:last").append(cursor);
                break; 

            }
                 //Миигание курсора
            //      clearInterval(interval)
            // interval = setInterval(function(){
            //     cursor.animate({"opacity": "0"}, 600, function(){
            //         cursor.css("opacity", "1");
            //     });
            // }, 100)
        })

        $(".kix-char").live("mousedown", function(){ console.log(this)
            removeCursor()
            $(this).before(cursor)
        })

        $(document).live('keypress', function(eventObject){
            cursor.before("<span class='kix-char'>" + String.fromCharCode(eventObject.which) + "</span>")
        })


})
</script>
</body>
</html>